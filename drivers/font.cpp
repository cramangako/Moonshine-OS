#include "font.h"

// Classic 8x8 bitmap font (one byte per row, bit 7 = leftmost pixel).
// Characters 0-31 are control chars (blank). 32-126 are printable ASCII.
// 127-255 are zero-initialized automatically by C++.
static const uint8_t font[256][8] = {
    // 0-31: control characters â€” all blank
    {},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},
    {},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},

    /* 32 space */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 33 !     */ {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00},
    /* 34 "     */ {0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 35 #     */ {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0x00},
    /* 36 $     */ {0x0C,0x3F,0x03,0x1E,0x30,0x3F,0x0C,0x00},
    /* 37 %     */ {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0x00},
    /* 38 &     */ {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0x00},
    /* 39 '     */ {0x06,0x06,0x03,0x00,0x00,0x00,0x00,0x00},
    /* 40 (     */ {0x18,0x0C,0x06,0x06,0x06,0x0C,0x18,0x00},
    /* 41 )     */ {0x06,0x0C,0x18,0x18,0x18,0x0C,0x06,0x00},
    /* 42 *     */ {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00},
    /* 43 +     */ {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00},
    /* 44 ,     */ {0x00,0x00,0x00,0x00,0x18,0x18,0x0C,0x00},
    /* 45 -     */ {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00},
    /* 46 .     */ {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00},
    /* 47 /     */ {0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00},
    /* 48 0     */ {0x3C,0x66,0x72,0x7A,0x6E,0x66,0x3C,0x00},
    /* 49 1     */ {0x18,0x1C,0x18,0x18,0x18,0x18,0x7E,0x00},
    /* 50 2     */ {0x3C,0x66,0x60,0x30,0x18,0x0C,0x7E,0x00},
    /* 51 3     */ {0x3C,0x66,0x60,0x38,0x60,0x66,0x3C,0x00},
    /* 52 4     */ {0x30,0x38,0x3C,0x36,0x7F,0x30,0x30,0x00},
    /* 53 5     */ {0x7E,0x06,0x3E,0x60,0x60,0x66,0x3C,0x00},
    /* 54 6     */ {0x38,0x0C,0x06,0x3E,0x66,0x66,0x3C,0x00},
    /* 55 7     */ {0x7E,0x66,0x60,0x30,0x18,0x18,0x18,0x00},
    /* 56 8     */ {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00},
    /* 57 9     */ {0x3C,0x66,0x66,0x7C,0x60,0x30,0x1C,0x00},
    /* 58 :     */ {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00},
    /* 59 ;     */ {0x00,0x18,0x18,0x00,0x18,0x18,0x0C,0x00},
    /* 60 <     */ {0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x00},
    /* 61 =     */ {0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00},
    /* 62 >     */ {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00},
    /* 63 ?     */ {0x3C,0x66,0x60,0x30,0x18,0x00,0x18,0x00},
    /* 64 @     */ {0x3E,0x63,0x7B,0x7B,0x7B,0x03,0x3E,0x00},
    /* 65 A     */ {0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00},
    /* 66 B     */ {0x3E,0x66,0x66,0x3E,0x66,0x66,0x3E,0x00},
    /* 67 C     */ {0x3C,0x66,0x06,0x06,0x06,0x66,0x3C,0x00},
    /* 68 D     */ {0x1E,0x36,0x66,0x66,0x66,0x36,0x1E,0x00},
    /* 69 E     */ {0x7E,0x06,0x06,0x3E,0x06,0x06,0x7E,0x00},
    /* 70 F     */ {0x7E,0x06,0x06,0x3E,0x06,0x06,0x06,0x00},
    /* 71 G     */ {0x3C,0x66,0x06,0x76,0x66,0x66,0x3C,0x00},
    /* 72 H     */ {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00},
    /* 73 I     */ {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    /* 74 J     */ {0x78,0x30,0x30,0x30,0x33,0x33,0x1E,0x00},
    /* 75 K     */ {0x66,0x36,0x1E,0x0E,0x1E,0x36,0x66,0x00},
    /* 76 L     */ {0x06,0x06,0x06,0x06,0x06,0x66,0x7E,0x00},
    /* 77 M     */ {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00},
    /* 78 N     */ {0x63,0x67,0x6F,0x7B,0x73,0x63,0x63,0x00},
    /* 79 O     */ {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    /* 80 P     */ {0x3E,0x66,0x66,0x3E,0x06,0x06,0x06,0x00},
    /* 81 Q     */ {0x3C,0x66,0x66,0x66,0x76,0x3C,0x60,0x00},
    /* 82 R     */ {0x3E,0x66,0x66,0x3E,0x36,0x66,0x66,0x00},
    /* 83 S     */ {0x3C,0x66,0x06,0x3C,0x60,0x66,0x3C,0x00},
    /* 84 T     */ {0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00},
    /* 85 U     */ {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    /* 86 V     */ {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00},
    /* 87 W     */ {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00},
    /* 88 X     */ {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00},
    /* 89 Y     */ {0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00},
    /* 90 Z     */ {0x7E,0x66,0x30,0x18,0x0C,0x66,0x7E,0x00},
    /* 91 [     */ {0x1E,0x06,0x06,0x06,0x06,0x06,0x1E,0x00},
    /* 92 \     */ {0x03,0x06,0x0C,0x18,0x30,0x60,0x40,0x00},
    /* 93 ]     */ {0x1E,0x18,0x18,0x18,0x18,0x18,0x1E,0x00},
    /* 94 ^     */ {0x18,0x3C,0x66,0x00,0x00,0x00,0x00,0x00},
    /* 95 _     */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
    /* 96 `     */ {0x06,0x0C,0x18,0x00,0x00,0x00,0x00,0x00},
    /* 97 a     */ {0x00,0x00,0x3C,0x60,0x7C,0x66,0x7C,0x00},
    /* 98 b     */ {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00},
    /* 99 c     */ {0x00,0x00,0x3C,0x06,0x06,0x06,0x3C,0x00},
    /* 100 d    */ {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00},
    /* 101 e    */ {0x00,0x00,0x3C,0x66,0x7E,0x06,0x3C,0x00},
    /* 102 f    */ {0x38,0x0C,0x0C,0x1E,0x0C,0x0C,0x0C,0x00},
    /* 103 g    */ {0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x3C},
    /* 104 h    */ {0x06,0x06,0x3E,0x66,0x66,0x66,0x66,0x00},
    /* 105 i    */ {0x18,0x00,0x1E,0x18,0x18,0x18,0x7E,0x00},
    /* 106 j    */ {0x60,0x00,0x7E,0x60,0x60,0x66,0x3C,0x00},
    /* 107 k    */ {0x06,0x06,0x66,0x36,0x1E,0x36,0x66,0x00},
    /* 108 l    */ {0x1C,0x18,0x18,0x18,0x18,0x18,0x7E,0x00},
    /* 109 m    */ {0x00,0x00,0x33,0x7F,0x7F,0x6B,0x63,0x00},
    /* 110 n    */ {0x00,0x00,0x3E,0x66,0x66,0x66,0x66,0x00},
    /* 111 o    */ {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00},
    /* 112 p    */ {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06},
    /* 113 q    */ {0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60},
    /* 114 r    */ {0x00,0x00,0x3E,0x66,0x06,0x06,0x06,0x00},
    /* 115 s    */ {0x00,0x00,0x7C,0x06,0x3C,0x60,0x3E,0x00},
    /* 116 t    */ {0x0C,0x0C,0x3E,0x0C,0x0C,0x0C,0x38,0x00},
    /* 117 u    */ {0x00,0x00,0x66,0x66,0x66,0x66,0x7C,0x00},
    /* 118 v    */ {0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00},
    /* 119 w    */ {0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00},
    /* 120 x    */ {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00},
    /* 121 y    */ {0x00,0x00,0x66,0x66,0x66,0x7C,0x60,0x3C},
    /* 122 z    */ {0x00,0x00,0x7E,0x30,0x18,0x0C,0x7E,0x00},
    /* 123 {    */ {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00},
    /* 124 |    */ {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00},
    /* 125 }    */ {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00},
    /* 126 ~    */ {0x6E,0x3B,0x00,0x00,0x00,0x00,0x00,0x00},
};

// Each character is 8px wide and 8px tall.
// bit 7 of each row byte = leftmost pixel, bit 0 = rightmost.
void font_draw_char(limine_framebuffer* fb, uint64_t x, uint64_t y,
                    char c, uint32_t fg, uint32_t bg) {
    const uint8_t* glyph = font[(uint8_t)c];

    for (int row = 0; row < 8; row++) {
        for (int col = 0; col < 8; col++) {
            // Check if this pixel is set in the bitmap (bit 0 = leftmost)
            bool lit = (glyph[row] >> col) & 1;
            uint32_t color = lit ? fg : bg;

            uint8_t* pixel = (uint8_t*)fb->address
                           + (y + row) * fb->pitch
                           + (x + col) * (fb->bpp / 8);
            *(uint32_t*)pixel = color;
        }
    }
}

// Draws a string, advancing x by 8 per character.
// '\n' moves to the next line (y += 10 for 1px gap between lines).
// Wraps automatically when text would go off the right edge.
void font_draw_string(limine_framebuffer* fb, uint64_t start_x, uint64_t y,
                      const char* str, uint32_t fg, uint32_t bg) {
    uint64_t x = start_x;

    for (int i = 0; str[i] != '\0'; i++) {
        if (str[i] == '\n' || x + 8 > fb->width) {
            x  = start_x;
            y += 10;  // 8px glyph height + 2px line gap
            if (str[i] == '\n') continue;
        }
        font_draw_char(fb, x, y, str[i], fg, bg);
        x += 8;
    }
}
